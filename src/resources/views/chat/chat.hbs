<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <title>Document</title>
    <link rel="stylesheet" href="/css/chat.css">

</head>

<body>
    <input type="hidden" value="{{receiver_id}}" id="receiver_id">
    <input type="hidden" id="sender_id" value="{{sender._id}}">

    <div class="main">
        <div class="name">
            <span><i class="far fa-user"></i></span>
            <input type="text" id="name-input" class="name-input" value="{{sender.name}}" maxlength="20">
        </div>
        <ul class="message-container" id="message-container">

            {{#each messages}}

            <p class="message">
                <li class="{{#if isOwnMessage}}message-right{{else}}message-left{{/if}}">
                    <p class="message">
                        {{this.message}}
                        <span>{{this.timestamp}}</span>
                    </p>
                </li>

            </p>

            {{/each}}




        </ul>
        <form action="" class="message-form" id="message-form">
            <input type="text" name="message" id="message-input" class="message-input">
            <div class="v-divider"></div>
            <button type="submit" class="send-button">
                send <span></span>
            </button>
        </form>

    </div>
    <br> <br>
    <h3 class="client-total" id="client-total">Total client 1</h3>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js" crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>
    <script>

        const socket = io();
        const receiverId = document.getElementById('receiver_id').value;
        const senderId = document.getElementById('sender_id').value;

        const clientsTotal = document.getElementById('client-total');
        const messageContainer = document.getElementById('message-container');
        const nameInput = document.getElementById('name-input');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');

        // Khi người dùng đăng nhập, phát sự kiện 'login' với user_id

        socket.emit('chat', senderId);

        messageForm.addEventListener('submit', (e) => {
            e.preventDefault();
            sendMessage();

        })
        socket.on('clients-total', (data) => {

            clientsTotal.innerText = `Total Clients: ${data}`

        })

        function sendMessage() {
            const data = {
                name: nameInput.value,
                message: messageInput.value,
                receiver_id: receiverId,
                sender_id: senderId,

            }
            socket.emit('message', data)
            addMessageToUI(true, data);


            messageInput.value = '';


        }


        socket.on('receiveMessage', (data) => { // nhan tin nhan tu nguoi dung khac

            if (data.receiver_id === senderId && data.sender_id === receiverId) {
                addMessageToUI(false, data)

            }
            else {
                console.log('k dc nhan tin nhan:', data.receiver_id)
            }
        })

        function addMessageToUI(isOwnMessage, data) {
            const element = `
            <li class="${isOwnMessage ? "message-right" : "message-left"}">
                <p class="message">
                    ${data.message}
                    <span>${data.name} : ${moment(data.dateTime).fromNow()}</span>
                </p>
            </li>`;

            messageContainer.innerHTML += element;


        }

    </script>

</body>

</html>